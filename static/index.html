<!DOCTYPE html>
<html lang="ja">


<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<link rel="stylesheet" href="./style.css">
<title>WebSocketTest</title>

<body>
    <div class="container">
        <form class="name-form">
            <input type="text" name="nickname" placeholder="nickname" required>
            <button>submit chat</button>
        </form>
        <div class="chatroom hidden">
            <ul class="chat-list">
                <!-- <li>
                    <div class="name">hello</div>
                    <div class="msg">hello</div>
                </li> -->
            </ul>
            <form class="chat-form">
                <input type="text" name="msg" placeholder="msg" required>
                <button>send</button>
            </form>
        </div>
    </div>
    <script type='module'>
        const host = `ws://localhost:8002/ws`
        const ws = new WebSocket(host)

        const nameForm = document.querySelector('.name-form');
        const chatroom = document.querySelector('.chatroom');
        const chatList = document.querySelector('.chat-list');
        const chatForm = document.querySelector('.chat-form');

        // name
        let nickname = "anonymous"

        nameForm.addEventListener('submit', (e) => {
            e.preventDefault();

            name = nameForm.nickname.value

            nameForm.classList.add("hidden")
            chatroom.classList.remove("hidden")
        })

        // チャットを送信
        chatForm.addEventListener("submit", (e) => {
            e.preventDefault();

            const msg = chatForm.msg.value

            const sessionId = localStorage.getItem("session_id") || ""
            ws.send(JSON.stringify({
                event: "message",
                data: {
                    message: msg,
                    name: name,
                }
            }))
            chatForm.reset()
        })

        const outputMessage = ({ data }) => {
            console.log(data)
            const { name, message } = JSON.parse(data)

            const template = `
            <li>
                <div class="name">${name}</div>
                <div class="msg">${message}</div>
            </li>
            `

            chatList.innerHTML += template
        }

        ws.addEventListener("message", outputMessage)


    </script>
</body>

</html>